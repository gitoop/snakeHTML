<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake</title>
</head>
<body dir="ltr">
    <style>
        body{
            background-color:black;
            color: green;
            font-family: monospace;
        }
        .gameTile{
            margin:2px;
            width: 30px;
            height: 30px;
        }
        .gameRow{
            display: flex;
            flex-direction: row;
            width: fit-content;
        }
        #gameContainer{
            margin-top:50px;
            width:100%;
            display: flex;
            justify-content: center;
        }
        #gameBoard{
            display: flex;
            flex-direction: column;
            border:3px solid green;
            width: fit-content;
            border-radius: 3px;
        }
        .banner{
            min-width: 25%;
            margin:50px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .optionContainer{
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        p{
            text-align: center;
            white-space: pre;
            margin: 2px 0;
        }
        button{
            background-color: transparent;
            color: green;
            padding: 10px 20px;
            margin: 0 3px;
            border: 1px solid green;
            border-radius: 5px;
            cursor: pointer;
            width: 85px;
        }
        button:active{
            background-color: rgb(55, 83, 55) !important;
        }
        button:hover{
            background-color: rgb(18, 27, 18);
        }
        button.selected{
            background-color: rgb(18, 27, 18);
        }
        .snake{
            background-color: green;
        }
        .food:not(.snake){
            background-color: red;
            border-radius: 50%;
        }
        .gameMessage{
            position:absolute;
            transform: translate(-50%, -50%);
            top:50%;
            left: 50%;
            font-weight: bolder;
            font-size: 400%;
            text-align: center;
            background-color: rgb(0, 0, 0, 60%);
        }
        #gameOver{
            color: red;
            display: none;
        }
        #gamePause{
            color: green;
            display: none;
        }
    </style>
    <div style="display: flex; flex-direction: row;" >
        <div id="leftBanner" class="banner">
            <span style="white-space: pre;">
  /$$$$$$$ /$$$$$$$   /$$$$$$  /$$   /$$  /$$$$$$ 
 /$$_____/| $$__  $$ |____  $$| $$  /$$/ /$$__  $$
|  $$$$$$ | $$  \ $$  /$$$$$$$| $$$$$$/ | $$$$$$$$
 \____  $$| $$  | $$ /$$__  $$| $$_  $$ | $$_____/
 /$$$$$$$/| $$  | $$|  $$$$$$$| $$ \  $$|  $$$$$$$
|_______/ |__/  |__/ \_______/|__/  \__/ \_______/
            </span>
            <p>welcome to snake</p>
            <p>a small fun interactive game</p>
            <p>where there is only one rule</p>
            <b style="font-size: 120%;">don't die</b>
            <p>(and space to start\restart)</p>
            <p>(aaaand p to pause\unpause)</p>
            <br/>
            <p>have fun</p>
            <br/>
            <br/>
            <br/>
            <br/>
            <div style="display: flex;">
                <p>score: </p>
                <p id="score">0</p>
            </div>
        </div>
        <div id="gameContainer" style="position: relative;">
            <div id="gameOver" class="gameMessage">YOU DIED</div>
            <div id="gamePause" class="gameMessage">RUN LIKE A BIT**</div>
            <div id="gameBoard"></div>
        </div>
        <div id="rightBanner" class="banner">
            <b style="text-decoration: underline;font-size:150% ;">game options</b>
            <div class="optionContainer">
                <h4>speed</h4>
                <div style="display: flex;" option="GAME_TICK">
                    <button value="200">baby</button>
                    <button value="100" class="selected">man</button>
                    <button value="50">legend</button>
                </div>
            </div>
            <div class="optionContainer">
                <h4>food amount</h4>
                <div style="display: flex;" option="food_amount">
                    <button value="1" class="selected">1</button>
                    <button value="2">2</button>
                    <button value="3">3</button>
                </div>
            </div>
            <div class="optionContainer">
                <h4>mode</h4>
                <div style="display: flex;" option="wrap_mode">
                    <button value="no-wrap" class="selected">no-wrap</button>
                    <button value="wrap">wrap</button>
                    <button value="crazy">crazy</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        const DEFAULT_SNAKE_SIZE = 5;
        const INITIAL_HEAD_POSITION = { top: 8, left: 10 };
        const DEFAULT_GRID_SIZE = { height: 15, width: 20 };
        const DIRECTIONS ={
            RIGHT:"ArrowRight",
            LEFT:"ArrowLeft",
            UP: "ArrowUp",
            DOWN:"ArrowDown"
        }
        const GAME_STATE = {
            direction: null,
            SNAKE_COORDS: [],
            BOARD_TILES:[],
            active: false,
            GAME_TICK: 100,
            food_amount: 1,
            wrap_mode: 'no-wrap',
            pause: false,
            last_step: 0,
        }

        function initBoard(){
            const board = document.querySelector(`#gameBoard`);
            board.innerHTML = "";
            GAME_STATE.BOARD_TILES = []
            for(let i=0; i<DEFAULT_GRID_SIZE.height;i++){
                let row = generateElement('div',{class:'gameRow'});
                GAME_STATE.BOARD_TILES[i] = []
                for(let j=0; j<DEFAULT_GRID_SIZE.width;j++){
                    let tile = generateElement('div',{ class:'gameTile', id:`gameTile_${i}_${j}` })
                    GAME_STATE.BOARD_TILES[i][j] = tile
                    row.append(tile)
                }
                board.append(row)
            }
        }

        function initSnake(){
            GAME_STATE.SNAKE_COORDS.length = 0
            for(let i=0;i<DEFAULT_SNAKE_SIZE;i++){
                if(INITIAL_HEAD_POSITION.left-i<0) return;
                let tile = GAME_STATE.BOARD_TILES[INITIAL_HEAD_POSITION.top][INITIAL_HEAD_POSITION.left-i]
                tile.classList.toggle(`snake`)
                tile.setAttribute('snakePiece', i)
                GAME_STATE.SNAKE_COORDS.push([INITIAL_HEAD_POSITION.top, INITIAL_HEAD_POSITION.left-i])
            }
        }

        function startGame(){
            document.querySelector('#gameOver').style.display = 'none';
            document.querySelector('#score').textContent = '0';
            initBoard();
            initSnake();
            createFood();
            GAME_STATE.direction = DIRECTIONS.RIGHT
            GAME_STATE.active = true;
            requestAnimationFrame(gameClock);
        }
        function gameOver(){
            GAME_STATE.active = false;
            document.querySelector('#gameOver').style.display = 'block';
        }
        function stopGame(){
            GAME_STATE.active = false;
            document.querySelector('#gameOver').style.display = 'none';
            initBoard();
        }
        function togglePauseGame(){
            GAME_STATE.pause = !GAME_STATE.pause
            document.querySelector('#gamePause').style.display = GAME_STATE.pause? 'block' : 'none';
            if(!GAME_STATE.pause) requestAnimationFrame(gameClock);
        }
        function gameClock(timestamp){
            if(!GAME_STATE.active || GAME_STATE.pause) return;
            if(timestamp - GAME_STATE.last_step > GAME_STATE.GAME_TICK){
                GAME_STATE.last_step = timestamp;
                moveSnake();
            }
            requestAnimationFrame(gameClock)
        }

        function moveSnake(){
            let [i,j] = GAME_STATE.SNAKE_COORDS[0]
            switch(GAME_STATE.direction){
                case DIRECTIONS.RIGHT:j++;break;
                case DIRECTIONS.LEFT:j--;break;
                case DIRECTIONS.UP:i--;break;
                case DIRECTIONS.DOWN:i++;break;
            }
            let tile = GAME_STATE.BOARD_TILES[i]?.[j]
            if((GAME_STATE.wrap_mode == 'no-wrap' && !tile) || tile?.classList?.contains('snake')) return gameOver();
            else if (!tile) [i, j, tile] = recalcTileAndCoords(i,j)
            if(!tile) return gameOver();

            tile.classList.toggle(`snake`)
            tile.setAttribute('snakePiece', 0)
            if(tile.classList.contains('food')){
                document.querySelector('#score').textContent++ 
                createFood();
            } 
            GAME_STATE.SNAKE_COORDS.forEach(coords => {
                const tile = GAME_STATE.BOARD_TILES[coords[0]][coords[1]]
                tile?.setAttribute('snakePiece', parseInt(tile.getAttribute('snakePiece'))+1)
            })
            GAME_STATE.SNAKE_COORDS.unshift([i,j])
            let last_coords = GAME_STATE.SNAKE_COORDS.at(-1)
            let last = GAME_STATE.BOARD_TILES[last_coords[0]][last_coords[1]]
            if(last.classList.contains('food'))
                last.classList.toggle(`food`)
            else{
                last.classList.toggle(`snake`)
                last.removeAttribute('snakePiece')
                GAME_STATE.SNAKE_COORDS.pop()
            }
        }

        function handleKeyPress(e){
            if(e.key == ' ' && !GAME_STATE.active) return startGame()
            if(e.code == 'KeyP' && GAME_STATE.active) return togglePauseGame()
            else if (e.key.includes('Arrow')) redirectSnake(e.key)
        }

        function redirectSnake(key){        
            const first = GAME_STATE.SNAKE_COORDS[0]
            const second = GAME_STATE.SNAKE_COORDS[1]
            if(!Object.values(DIRECTIONS).includes(key)
                || (first[1] != second[1] && [DIRECTIONS.RIGHT, DIRECTIONS.LEFT].includes(key))
                || (first[0] != second[0] && [DIRECTIONS.UP, DIRECTIONS.DOWN].includes(key))
            ) return;
            GAME_STATE.direction = key
        }

        function generateElement(tag, args = {}){
            let el = document.createElement(tag)
            el.className = args.class ?? ''
            el.id = args.id ?? ''
            return el
        }

        function createFood(){
            let foodOnScreen = document.querySelectorAll(`.food:not(.snake)`).length
            for(let i=0; i<GAME_STATE.food_amount - foodOnScreen; i++){
                let nonSnakeTiles = document.querySelectorAll(`.gameTile:not(.snake):not(.food)`)
                nonSnakeTiles[Math.floor(Math.random()*nonSnakeTiles.length)].classList.add('food')
            }        
        }

        function changeGameState(e){
            let el = e.target
            GAME_STATE[el.closest('[option]').getAttribute('option')] = el.getAttribute('value')
            el.parentElement.querySelector(".selected").classList.toggle('selected')
            el.classList.toggle('selected')
            stopGame()
            el.blur()
        }

        function recalcTileAndCoords(i, j){
            if(GAME_STATE.wrap_mode == 'crazy'){
                if(i<0) [i,j] = [Math.floor(DEFAULT_GRID_SIZE.height*(DEFAULT_GRID_SIZE.width-j)/DEFAULT_GRID_SIZE.width),DEFAULT_GRID_SIZE.width - 1]
                if(i>=DEFAULT_GRID_SIZE.height) [i,j] = [Math.floor(DEFAULT_GRID_SIZE.height*(DEFAULT_GRID_SIZE.width-j)/DEFAULT_GRID_SIZE.width),0]
                if(j<0) [i,j] = [DEFAULT_GRID_SIZE.height-1,Math.floor(DEFAULT_GRID_SIZE.width*(DEFAULT_GRID_SIZE.height-i)/DEFAULT_GRID_SIZE.height)]
                if(j>=DEFAULT_GRID_SIZE.width) [i,j] = [0,Math.floor(DEFAULT_GRID_SIZE.width*(DEFAULT_GRID_SIZE.height-i)/DEFAULT_GRID_SIZE.height)]
                const directionMap = {}
                directionMap[DIRECTIONS.RIGHT] = DIRECTIONS.DOWN;
                directionMap[DIRECTIONS.LEFT] = DIRECTIONS.UP;
                directionMap[DIRECTIONS.UP] = DIRECTIONS.LEFT;
                directionMap[DIRECTIONS.DOWN] = DIRECTIONS.RIGHT;
                GAME_STATE.direction = directionMap[GAME_STATE.direction]
            } else{
                if(i<0) i = DEFAULT_GRID_SIZE.height - 1
                if(i>=DEFAULT_GRID_SIZE.height) i = 0
                if(j<0) j = DEFAULT_GRID_SIZE.width - 1
                if(j>=DEFAULT_GRID_SIZE.width) j = 0
            }
            return [i, j, GAME_STATE.BOARD_TILES[i][j]] 
        }

        initBoard();
        document.addEventListener('keydown', handleKeyPress)
        document.querySelectorAll('#rightBanner button').forEach(el => el.addEventListener('click', changeGameState)) 
    </script>
</body>

</html>

