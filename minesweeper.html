<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://kit.fontawesome.com/a566466632.js" crossorigin="anonymous"></script>
    <title>minesweeper</title>
</head>
<body>
    <style>
        :root{
            --hidden-gray:#333a41;
            --shown-gray:#444d53;
            --text-red:#d14a4a;
            --number-1:#4da3ff;
            --number-2:#4caf50;
            --number-3:#e25555;
            --number-4:#5c6bc0;
            --number-5:#c06262;
            --number-6:#4db6ac;
            --number-7:#e0e6eb;
            --number-8:#9aa4ad;
            --border-top:#C0C0C0;
            --border-bottom:#808080;
            --border:#22282f;
            --smiley-yellow:#f4c542;
        }
        body{
            background-color:black;
            color: var(--text-red);
            font-family: monospace;
        }
        p{
            text-align: center;
            white-space: pre;
            margin: 2px 0;
        }
        #gameContainer{
            margin-top:50px;
            width:100%;
            display: flex;
            justify-content: center;
        }
        #gameContainer > div{
            display: flex;
            align-items: center;
            flex-direction: column;
            width: fit-content;
        }
        #boardHeader{
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            background-color: var(--shown-gray);
            border: 5px solid var(--border-top);
            border-style: inset;
            width: calc(100% - 30px);
            padding: 5px 10px
        }
        #smiley{
            color:var(--smiley-yellow);
            height: 30px !important;
            width: 30px !important;
            font-size: larger;
        }
        #boardContainer{
            border: 5px solid var(--border-top);
            background-color: var(--border-top);
            border-style: outset;
            height: fit-content;
        }
        #gameBoard{
            display: flex;
            flex-direction: column;
            width: fit-content;
            border-radius: 3px;
            border: 5px solid var(--border-top);
            border-style: inset;
        }
        .optionContainer{
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        button{
            background-color: transparent;
            color: var(--text-red);
            padding: 10px 20px;
            margin: 0 3px;
            border: 1px solid var(--text-red);
            border-radius: 5px;
            cursor: pointer;
            width: 85px;
        }
        button:active{
            background-color: var(--border-top) !important;
        }
        button:hover{
            background-color: var(--border-bottom);
        }
        button.selected{
            background-color: var(--border);
        }
        .banner{
            min-width: 35%;
            margin:50px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .row{
            display: flex;
            flex-direction: row;
            width: fit-content;
        }
        .tile {
            width: 24px;
            height: 24px;
            background: var(--shown-gray);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
        }
        .tile:not(:has(.fa-solid)):not(.fa-solid){
            font-weight: bold;
            font-size: x-large;
        }
        .tile-inner, #smiley {
            height: 20px;
            width: 20px;
            border-top: 2px solid var(--border-top);
            border-left: 2px solid var(--border-top);
            border-bottom: 2px solid black;
            border-right: 2px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--hidden-gray);
        }
        .tile-inner:not(.fa-solid):active, #smiley:active{
            border-top: 2px solid black;
            border-left: 2px solid black;
            border-bottom: 2px solid var(--border-top);
            border-right: 2px solid var(--border-top);
        }
        .wrongFlag{
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            text-align: center;
            z-index: 1;
            color: black;
            font-weight: bold;
            font-size: x-large;
        }
        .fa-solid.fa-flag{
            color:var(--number-3)
        }
        .fa-solid.fa-question{
            color:var(--number-6)
        }
        .fa-solid.fa-land-mine-on{
            color:black
        }
        .redText{
            color: var(--text-red);
            width: 34px;
            text-align: right;
            font-size: x-large;
            padding: 0 2px;
            font-weight: bold;
            border-top: 2px solid var(--border-top);
            border-left: 2px solid var(--border-top);
            border-bottom: 2px solid black;
            border-right: 2px solid black;
        }
    </style>
    <div style="display: flex; flex-direction: row;" >
        <div id="leftBanner" class="banner">
            <span style="white-space: pre;"> /$$$$$$/$$$$  /$$ /$$$$$$$   /$$$$$$ 
| $$_  $$_  $$| $$| $$__  $$ /$$__  $$
| $$ \ $$ \ $$| $$| $$  \ $$| $$$$$$$$
| $$ | $$ | $$| $$| $$  | $$| $$_____/
| $$ | $$ | $$| $$| $$  | $$|  $$$$$$$
|__/ |__/ |__/|__/|__/  |__/ \_______/</span>
            <span style="white-space: pre;">  /$$$$$$$ /$$  /$$  /$$  /$$$$$$   /$$$$$$   /$$$$$$   /$$$$$$   /$$$$$$ 
 /$$_____/| $$ | $$ | $$ /$$__  $$ /$$__  $$ /$$__  $$ /$$__  $$ /$$__  $$
|  $$$$$$ | $$ | $$ | $$| $$$$$$$$| $$$$$$$$| $$  \ $$| $$$$$$$$| $$  \__/
 \____  $$| $$ | $$ | $$| $$_____/| $$_____/| $$  | $$| $$_____/| $$      
 /$$$$$$$/|  $$$$$/$$$$/|  $$$$$$$|  $$$$$$$| $$$$$$$/|  $$$$$$$| $$      
|_______/  \_____/\___/  \_______/ \_______/| $$____/  \_______/|__/      
                                            | $$                          
                                            | $$                          
                                            |__/                          
            </span>
            <p>welcome to minesweeper</p>
            <p>a small fun interactive game</p>
            <p>where there is only one rule</p>
            <b style="font-size: 120%;">don't die</b>
            <br/>
            <p>have fun</p>

            <div class="optionContainer">
                <h4>size</h4>
                <div style="display: flex;" option="size">
                    <button value="1" class="selected">small</button>
                    <button value="2">medium</button>
                    <button value="3">large</button>
                </div>
            </div>
        </div>
        <div id="gameContainer" style="position: relative;">
            <div id="boardContainer">
                <div id="boardHeader">
                    <div id="minesLeft" class="redText"><span>10</span></div>
                    <div id="smiley" class="fa-solid fa-face-smile" onclick="startGame()"></div>
                    <div id="gameTime" class="redText"><span>0</span></div>
                </div>
                <div id="gameBoard"></div>
            </div>
        </div>
    </div>
    <script>
        const CONSTS = {
            MINE_NAME: 'mine',
            SMILE:{
                FA:'fa-solid fa-face-smile',
                TEXT:':D'
            },
            LAUGH:{
                FA:'fa-solid fa-face-laugh-squint',
                TEXT:'XD'
            },
            LOVE:{
                FA:'fa-solid fa-face-grin-hearts',
                TEXT:'<3'
            },
            MINE:{
                FA:'fa-solid fa-land-mine-on',
                TEXT:'B'
            },
            INNER_TILE_CLASS: '.tile-inner'

        }
        const SYMBOLS = {
            NONE: 0,
            FLAG: 1,
            Q_MARK: 2
        }
        const DEFAULT_TILE = {
            tile: null,
            symbol: SYMBOLS.NONE,
            visible: false,
            value: null
        }
        const ELEMENTS = {
            time: document.querySelector('#gameTime span'),
            board:  document.querySelector(`#gameBoard`),
            smiley: document.querySelector('#smiley'),
            mineCount: document.querySelector('#minesLeft span')
        }
        const isFA = !!window.FontAwesomeKitConfig
        const GAME_STATE = {
            MINES_AMOUNT : 10,
            VISIBLE_TILES: 0,
            GRID_SIZE: {
                height: 9,
                width: 9
            },
            FLAT_BOARD: [],
            BOARD_TILES: [],
            FLAGS: 0,
            ACTIVE: false,
            LAST_STEP: 0,
            GAME_TICK: 1000,
        }
        
        function generateElement(tag, args = {}){
            let el = document.createElement(tag)
            el.className  = args.class ?? ''
            el.id = args.id ?? ''
            return el
        }
        function gameClock(timestamp){
            if(!GAME_STATE.ACTIVE) return;
            if(timestamp - GAME_STATE.LAST_STEP > GAME_STATE.GAME_TICK){
                GAME_STATE.LAST_STEP = timestamp;
                let time = ELEMENTS.time.innerText
                if(time < 999)
                    ELEMENTS.time.innerText++
            }
            requestAnimationFrame(gameClock)
        }

        function startGame(){
            initBoard();
            generateMines();
            setTileValues();
            GAME_STATE.ACTIVE = true;
            GAME_STATE.FLAGS = 0;
            GAME_STATE.VISIBLE_TILES = 0;
            ELEMENTS.mineCount.innerText = GAME_STATE.MINES_AMOUNT
            ELEMENTS.time.innerText = 0
            ELEMENTS.smiley.className = CONSTS.SMILE.FA
            if(!isFA) ELEMENTS.smiley.innerText = CONSTS.SMILE.TEXT
            requestAnimationFrame(gameClock)
        }
        function gameLost(){
            GAME_STATE.ACTIVE = false;
            GAME_STATE.FLAT_BOARD.filter(tileObj => tileObj.value == CONSTS.MINE_NAME).forEach(tileObj =>{
                if(tileObj.symbol === SYMBOLS.FLAG) return;
                tileObj.tile.querySelector(CONSTS.INNER_TILE_CLASS).remove()
                tileObj.tile.className = `tile ${CONSTS.MINE.FA}`
                if(!isFA) tileObj.tile.innerText = CONSTS.MINE.TEXT
                tileObj.tile.style.backgroundColor = 'red'
            })
            GAME_STATE.FLAT_BOARD.filter(tileObj => tileObj.value != CONSTS.MINE_NAME && tileObj.symbol === SYMBOLS.FLAG).forEach(tileObj => {
                let span = generateElement('span',{class: 'wrongFlag'})
                span.innerText = 'X'
                tileObj.tile.append(span)
            })
            ELEMENTS.smiley.className = CONSTS.LAUGH.FA
            if(!isFA) ELEMENTS.smiley.innerText = CONSTS.SMILE.TEXT

        }
        function initBoard(){
            ELEMENTS.board.innerHTML = "";
            GAME_STATE.BOARD_TILES = []

            for(let i=0; i<GAME_STATE.GRID_SIZE.height;i++){
                let row = generateElement('div',{class:'row'});
                GAME_STATE.BOARD_TILES[i] = []
                for(let j=0; j<GAME_STATE.GRID_SIZE.width;j++){
                    let tile = generateElement('div',{ class:'tile', id:`gameTile_${i}_${j}` })
                    tile.append(generateElement('div',{ class:'tile-inner' }))
                    GAME_STATE.BOARD_TILES[i][j] = Object.assign({}, DEFAULT_TILE);
                    GAME_STATE.BOARD_TILES[i][j].tile = tile
                    row.append(tile)
                }
                ELEMENTS.board.append(row)
            }

            GAME_STATE.FLAT_BOARD = GAME_STATE.BOARD_TILES.flat()
        }
        function generateMines(){
            let boardArr = [...GAME_STATE.FLAT_BOARD]
            for(let i = 0; i < GAME_STATE.MINES_AMOUNT; i++){
                let mine = boardArr.splice(Math.floor(Math.random()*boardArr.length),1)[0]
                mine.value = CONSTS.MINE_NAME
            }
        }
        function setTileValues(){
            for(let i = 0; i < GAME_STATE.BOARD_TILES.length; i++)
                for(let j = 0; j < GAME_STATE.BOARD_TILES[i].length; j++){
                    if(GAME_STATE.BOARD_TILES[i][j].value == CONSTS.MINE_NAME) continue;

                    let amount = countSurroundingMines(i,j)
                    if (amount > 0)
                        GAME_STATE.BOARD_TILES[i][j].value = amount
                }
        }
        function countSurroundingMines(i,j){
            let amount = 0
            for(let iDelta = -1; iDelta <= 1; iDelta++)
                for(let jDelta = -1; jDelta <= 1; jDelta++)
                    if(i + iDelta >= 0 && j + jDelta >= 0
                        && GAME_STATE.BOARD_TILES[i + iDelta]?.[j + jDelta]?.value == CONSTS.MINE_NAME)
                        amount++
            return amount
        }

        function pressTile(e){
            if(!GAME_STATE.ACTIVE) return;
            e.preventDefault();
            const el = e.target
            el.blur();
            const [i, j] = el.closest('.tile').id.split('_').slice(-2).map(Number)
             , tileObj = GAME_STATE.BOARD_TILES[i][j];

            if(e.button == 2) return setInnerTileIcon(i, j)
            else if(e.button == 1) tileObj.visible && checkRevaelSurrounding(i, j)
            else{
                if(tileObj.visible || tileObj.symbol !== SYMBOLS.NONE) return;
                revealBoard(i, j)           
            }
            checkWinCondition()
        }
        function checkWinCondition(){
            let nonVisibleTiles = (GAME_STATE.GRID_SIZE.height * GAME_STATE.GRID_SIZE.width) - GAME_STATE.VISIBLE_TILES;
            if(nonVisibleTiles != GAME_STATE.MINES_AMOUNT) return;

            ELEMENTS.smiley.className = CONSTS.LOVE.FA
            if(!isFA) ELEMENTS.smiley.innerText = CONSTS.LOVEs.TEXT
            GAME_STATE.ACTIVE = false;
        }

        function setInnerTileIcon(i, j){
            const tileObj = GAME_STATE.BOARD_TILES[i][j];
            const tileInner = tileObj.tile.querySelector(CONSTS.INNER_TILE_CLASS)
            if(tileObj.visible || !GAME_STATE.ACTIVE) return;

            if(tileObj.symbol === SYMBOLS.NONE){
                tileInner.classList.add('fa-solid', 'fa-flag')
                if(!isFA) tileInner.innerText = 'F'
                GAME_STATE.FLAGS++
                tileObj.symbol = SYMBOLS.FLAG
            }
            else if(tileObj.symbol === SYMBOLS.FLAG){
                tileInner.classList.remove('fa-flag')
                tileInner.classList.add('fa-question')
                if(!isFA) tileInner.innerText = '?'
                GAME_STATE.FLAGS--
                tileObj.symbol = SYMBOLS.Q_MARK
            }
            else if(tileObj.symbol === SYMBOLS.Q_MARK){
                tileInner.classList.remove('fa-solid', 'fa-question')
                if(!isFA) tileInner.innerText = ''
                tileObj.symbol = SYMBOLS.NONE
            }

            ELEMENTS.mineCount.innerText = GAME_STATE.MINES_AMOUNT - GAME_STATE.FLAGS
        }

        function checkRevaelSurrounding(i, j){
            const tile = GAME_STATE.BOARD_TILES[i][j].tile
            if(!tile.innerText || countSurroundingFlags(i,j) != tile.innerText) return;
            revealBoard(i, j, true)
        }
        function countSurroundingFlags(i,j){
            let amount = 0
            for(let iDelta = -1; iDelta <= 1; iDelta++)
                for(let jDelta = -1; jDelta <= 1; jDelta++)
                    if(i + iDelta >= 0 && j + jDelta >= 0
                        && GAME_STATE.BOARD_TILES[i + iDelta]?.[j + jDelta]?.symbol === SYMBOLS.FLAG)
                        amount++
            return amount
        }
        function revealBoard(startI, startJ, wheelClick = false){
            let tiles = [[startI,startJ]], firstRun = true
            while(tiles.length){
                let [i, j] = tiles.pop()
                if(!(wheelClick && firstRun)){
                    let tileObj = GAME_STATE.BOARD_TILES[i]?.[j]
                    if(!tileObj || tileObj.symbol === SYMBOLS.FLAG || (tileObj.symbol === SYMBOLS.Q_MARK && !wheelClick)
                        || tileObj.visible || !GAME_STATE.ACTIVE) 
                        continue;
                    if(tileObj.value == CONSTS.MINE_NAME) return gameLost()
    
                    tileObj.tile.querySelector(CONSTS.INNER_TILE_CLASS).remove();
                    GAME_STATE.VISIBLE_TILES++;
                    [tileObj.visible, tileObj.symbol] = [true, SYMBOLS.NONE];
                    if(tileObj.value){
                        tileObj.tile.innerText = tileObj.value
                        tileObj.tile.style.color = `var(--number-${tileObj.value})`
                        continue;
                    }
                }
                firstRun = false
                for(let iDelta = -1; iDelta <= 1; iDelta++)
                    for(let jDelta = -1; jDelta <= 1; jDelta++)
                        if(i + iDelta >= 0 && (iDelta != 0 || jDelta != 0))
                            tiles.push([i + iDelta, j + jDelta])
            }
        }

        function changeGameState(e){
            let el = e.target
            const v = el.getAttribute('value')
            GAME_STATE.GRID_SIZE.height = v == 1 ? 9 : v == 2 ? 16 : 16
            GAME_STATE.GRID_SIZE.width = v == 1 ? 9 : v == 2 ? 16 : 30
            GAME_STATE.MINES_AMOUNT = v == 1 ? 10 : v == 2 ? 40 : 99
            el.parentElement.querySelector(".selected").classList.toggle('selected')
            el.classList.toggle('selected')
            startGame()
            el.blur()
        }

        startGame()
        document.querySelectorAll('.optionContainer button').forEach(el => el.addEventListener('click', changeGameState)) 
        ELEMENTS.board.addEventListener('mouseup', pressTile)
        ELEMENTS.board.addEventListener('contextmenu', e => e.preventDefault())
    </script>
</body>
</html>
