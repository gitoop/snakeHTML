<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://kit.fontawesome.com/a566466632.js" crossorigin="anonymous"></script>
    <title>minesweeper</title>
</head>
<body>
    <style>
        :root{
            --hidden-gray:#333a41;
            --shown-gray:#444d53;
            --text-red:#d14a4a;
            --number-1:#4da3ff;
            --number-2:#4caf50;
            --number-3:#e25555;
            --number-4:#5c6bc0;
            --number-5:#c06262;
            --number-6:#4db6ac;
            --number-7:#e0e6eb;
            --number-8:#9aa4ad;
            --border-top:#C0C0C0;
            --border-bottom:#808080;
            --border:#22282f;
            --smiley-yellow:#f4c542;
        }
        body{
            background-color:black;
            color: var(--text-red);
            font-family: monospace;
        }
        p{
            text-align: center;
            white-space: pre;
            margin: 2px 0;
        }
        #gameContainer{
            margin-top:50px;
            width:100%;
            display: flex;
            justify-content: center;
        }
        #gameContainer > div{
            display: flex;
            align-items: center;
            flex-direction: column;
            width: fit-content;
        }
        #boardHeader{
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            background-color: var(--shown-gray);
            border: 5px solid var(--border-top);
            width: calc(100% - 30px);
            padding: 5px 10px
        }
        #smiley{
            color:var(--smiley-yellow);
            height: 30px !important;
            width: 30px !important;
            font-size: larger;
        }
        #gameBoard{
            display: flex;
            flex-direction: column;
            width: fit-content;
            border-radius: 3px;
        }
        .optionContainer{
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        button{
            background-color: transparent;
            color: var(--text-red);
            padding: 10px 20px;
            margin: 0 3px;
            border: 1px solid var(--text-red);
            border-radius: 5px;
            cursor: pointer;
            width: 85px;
        }
        button:active{
            background-color: var(--border-top) !important;
        }
        button:hover{
            background-color: var(--border-bottom);
        }
        button.selected{
            background-color: var(--border);
        }
        .banner{
            min-width: 35%;
            margin:50px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .row{
            display: flex;
            flex-direction: row;
            width: fit-content;
        }
        .tile {
            width: 24px;
            height: 24px;
            background: var(--shown-gray);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
        }
        .tile:not(:has(.fa-solid)):not(.fa-solid){
            font-weight: bold;
            font-size: x-large;
        }
        .tile-inner, #smiley {
            height: 20px;
            width: 20px;
            border-top: 2px solid var(--border-top);
            border-left: 2px solid var(--border-top);
            border-bottom: 2px solid black;
            border-right: 2px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--hidden-gray);
        }
        .tile-inner:not(.fa-solid):active, #smiley:active{
            border-top: 2px solid black;
            border-left: 2px solid black;
            border-bottom: 2px solid var(--border-top);
            border-right: 2px solid var(--border-top);
        }
        .wrongFlag{
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            text-align: center;
            z-index: 1;
            color: black;
            font-weight: bold;
            font-size: x-large;
        }
        .fa-solid.fa-flag{
            color:var(--number-3)
        }
        .fa-solid.fa-question{
            color:var(--number-6)
        }
        .fa-solid.fa-land-mine-on{
            color:black
        }
        .redText{
            color: var(--text-red);
            width: 34px;
            text-align: right;
            font-size: x-large;
            padding: 0 2px;
            font-weight: bold;
            border-top: 2px solid var(--border-top);
            border-left: 2px solid var(--border-top);
            border-bottom: 2px solid black;
            border-right: 2px solid black;
        }
    </style>
    <div style="display: flex; flex-direction: row;" >
        <div id="leftBanner" class="banner">
            <span style="white-space: pre;"> /$$$$$$/$$$$  /$$ /$$$$$$$   /$$$$$$ 
| $$_  $$_  $$| $$| $$__  $$ /$$__  $$
| $$ \ $$ \ $$| $$| $$  \ $$| $$$$$$$$
| $$ | $$ | $$| $$| $$  | $$| $$_____/
| $$ | $$ | $$| $$| $$  | $$|  $$$$$$$
|__/ |__/ |__/|__/|__/  |__/ \_______/</span>
            <span style="white-space: pre;">  /$$$$$$$ /$$  /$$  /$$  /$$$$$$   /$$$$$$   /$$$$$$   /$$$$$$   /$$$$$$ 
 /$$_____/| $$ | $$ | $$ /$$__  $$ /$$__  $$ /$$__  $$ /$$__  $$ /$$__  $$
|  $$$$$$ | $$ | $$ | $$| $$$$$$$$| $$$$$$$$| $$  \ $$| $$$$$$$$| $$  \__/
 \____  $$| $$ | $$ | $$| $$_____/| $$_____/| $$  | $$| $$_____/| $$      
 /$$$$$$$/|  $$$$$/$$$$/|  $$$$$$$|  $$$$$$$| $$$$$$$/|  $$$$$$$| $$      
|_______/  \_____/\___/  \_______/ \_______/| $$____/  \_______/|__/      
                                            | $$                          
                                            | $$                          
                                            |__/                          
            </span>
            <p>welcome to minesweeper</p>
            <p>a small fun interactive game</p>
            <p>where there is only one rule</p>
            <b style="font-size: 120%;">don't die</b>
            <br/>
            <p>have fun</p>

            <div class="optionContainer">
                <h4>size</h4>
                <div style="display: flex;" option="size">
                    <button value="1" class="selected">small</button>
                    <button value="2">medium</button>
                    <button value="3">large</button>
                </div>
            </div>
        </div>
        <div id="gameContainer" style="position: relative;">
            <div>
                <div id="boardHeader">
                    <div id="minesLeft" class="redText"><span>10</span></div>
                    <div id="smiley" class="fa-solid fa-face-smile" onclick="startGame()"></div>
                    <div id="gameTime" class="redText"><span>0</span></div>
                </div>
                <div id="gameBoard"></div>
            </div>
        </div>
    </div>
    <script>
        const DEFAULT_TILE = {
            tile: null,
            symbol: 0,
            visible: false,
            value: null
        }
        const elements = {
            time: document.querySelector('#gameTime span'),
            board:  document.querySelector(`#gameBoard`),
            smiley: document.querySelector('#smiley'),
            mineCount: document.querySelector('#minesLeft span')
        }
        const isFA = isFontAwesomeLoaded();
        const GAME_STATE = {
            MINES_AMOUNT : 10,
            GRID_SIZE: {
                height: 9,
                width: 9
            },
            FLAT_BOARD: [],
            BOARD_TILES: [],
            flags: 0,
            active: false,
            last_step: 0,
            GAME_TICK: 1000,
        }

        function gameClock(timestamp){
            if(!GAME_STATE.active) return;
            if(timestamp - GAME_STATE.last_step > GAME_STATE.GAME_TICK){
                GAME_STATE.last_step = timestamp;
                let time = elements.time.innerText
                if(time < 999)
                    elements.time.innerText++
            }
            requestAnimationFrame(gameClock)
        }

        function startGame(){
            initBoard();
            generateMines();
            setTileValues();
            GAME_STATE.active = true;
            GAME_STATE.flags = 0;
            elements.mineCount.innerText = GAME_STATE.MINES_AMOUNT
            elements.time.innerText = 0
            if(isFA){
                elements.smiley.className = 'fa-solid fa-face-smile'
            }
            else elements.smiley.innerText = ':D'
            requestAnimationFrame(gameClock)
        }
        function gameLost(){
            GAME_STATE.active = false;
            GAME_STATE.FLAT_BOARD.filter(tileObj => tileObj.value == 'mine').forEach(tileObj =>{
                if(tileObj.symbol == 1) return;
                tileObj.tile.querySelector('.tile-inner').remove()
                if(isFA){
                    tileObj.tile.classList.toggle('fa-solid')
                    tileObj.tile.classList.toggle('fa-land-mine-on')
                }
                else tileObj.tile.innerText = 'B'
                tileObj.tile.style.backgroundColor = 'red'
            })
            GAME_STATE.FLAT_BOARD.filter(tileObj => tileObj.value != 'mine' && tileObj.symbol == 1).forEach(tileObj => {
                let span = generateElement('span',{class: 'wrongFlag'})
                span.innerText = 'X'
                tileObj.tile.append(span)
            })
            if(isFA){
                elements.smiley.classList.toggle('fa-face-smile')
                elements.smiley.classList.toggle('fa-face-laugh-squint')
            }
            else elements.smiley.innerText = 'XD'

        }
        function initBoard(){
            elements.board.innerHTML = "";
            GAME_STATE.BOARD_TILES = []
            for(let i=0; i<GAME_STATE.GRID_SIZE.height;i++){
                let row = generateElement('div',{class:'row'});
                GAME_STATE.BOARD_TILES[i] = []
                for(let j=0; j<GAME_STATE.GRID_SIZE.width;j++){
                    let tile = generateElement('div',{ class:'tile', id:`gameTile_${i}_${j}` })
                    tile.append(generateElement('div',{ class:'tile-inner' }))
                    GAME_STATE.BOARD_TILES[i][j] = structuredClone(DEFAULT_TILE);
                    GAME_STATE.BOARD_TILES[i][j].tile = tile
                    row.append(tile)
                }
                elements.board.append(row)
            }
            GAME_STATE.FLAT_BOARD = GAME_STATE.BOARD_TILES.flat()
        }
        function generateMines(){
            let boardArr = [...GAME_STATE.FLAT_BOARD]
            for(let i = 0; i < GAME_STATE.MINES_AMOUNT; i++){
                let mine = boardArr.splice(Math.floor(Math.random()*boardArr.length),1)[0]
                mine.value = 'mine'
            }
        }
        function setTileValues(){
            for(let i = 0; i < GAME_STATE.BOARD_TILES.length; i++)
                for(let j = 0; j < GAME_STATE.BOARD_TILES[i].length; j++){
                    if(GAME_STATE.BOARD_TILES[i][j].value == 'mine') continue;
                    let amount = countSurroundingMines(i,j)
                    if (amount > 0)
                        GAME_STATE.BOARD_TILES[i][j].value = amount
                }
        }
        function countSurroundingMines(i,j){
            let amount = 0
            for(let iDelta = -1; iDelta <= 1; iDelta++)
                for(let jDelta = -1; jDelta <= 1; jDelta++)
                    if(i + iDelta >= 0 && j + jDelta >= 0
                        && GAME_STATE.BOARD_TILES[i + iDelta]?.[j + jDelta]?.value =='mine')
                        amount++
            return amount
        }
        function countSurroundingFlags(i,j){
            let amount = 0
            for(let iDelta = -1; iDelta <= 1; iDelta++)
                for(let jDelta = -1; jDelta <= 1; jDelta++)
                    if(i + iDelta >= 0 && j + jDelta >= 0
                        && GAME_STATE.BOARD_TILES[i + iDelta]?.[j + jDelta]?.symbol == 1)
                        amount++
            return amount
        }
        function generateElement(tag, args = {}){
            let el = document.createElement(tag)
            el.className  = args.class ?? ''
            el.id = args.id ?? ''
            return el
        }

        function pressTile(e){
            if(!GAME_STATE.active) return;
            e.preventDefault();
            const el = e.target
            el.blur();
            let [i, j] = el.closest('.tile').id.split('_').slice(-2).map(Number)
            if(e.button == 2) return setTileMode(i, j)
            if(e.button == 1) GAME_STATE.BOARD_TILES[i][j].visible && checkRevaelSurrounding(i, j)
            else{
                if(GAME_STATE.BOARD_TILES[i][j].visible || GAME_STATE.BOARD_TILES[i][j].symbol != 0) return;
                if(GAME_STATE.BOARD_TILES[i][j].value == 'mine') return gameLost();
                revealBoard(i, j)           
            }
            let nonVisibleTiles = GAME_STATE.FLAT_BOARD.filter(tileObj => !tileObj.visible).length;
            if(nonVisibleTiles != GAME_STATE.MINES_AMOUNT) return;
            if(isFA){
                elements.smiley.classList.toggle('fa-face-smile')
                elements.smiley.classList.toggle('fa-face-grin-hearts')
            }
            else elements.smiley.innerText = '<3'
            GAME_STATE.active = false;
        }
        function setTileMode(i, j){
            if(!GAME_STATE.active) return;
            const tileObj = GAME_STATE.BOARD_TILES[i][j];
            const tileInner = tileObj.tile.querySelector('.tile-inner')
            if(tileObj.visible) return;
            if(tileObj.symbol == 0){
                if(isFA){
                    tileInner.classList.toggle('fa-solid')
                    tileInner.classList.toggle('fa-flag')
                }
                else tileInner.innerText = 'F'
                GAME_STATE.flags++
                tileObj.symbol = 1
            }
            else if(tileObj.symbol == 1){
                if(isFA){
                    tileInner.classList.toggle('fa-flag')
                    tileInner.classList.toggle('fa-question')
                }
                else tileInner.innerText = '?'
                GAME_STATE.flags--
                tileObj.symbol = 2
            }
            else if(tileObj.symbol == 2){
                if(isFA){
                    tileInner.classList.toggle('fa-solid')
                    tileInner.classList.toggle('fa-question')
                }
                else tileInner.innerText = ''
                tileObj.symbol = 0
            }
            elements.mineCount.innerText = GAME_STATE.MINES_AMOUNT - GAME_STATE.flags
        }
        function revealBoard(startI, startJ, wheelClick = false){
            let tiles = [[startI,startJ]], firstRun = true
            while(tiles.length){
                let [i, j] = tiles.pop()
                if(!(wheelClick && firstRun)){
                    let tileObj = GAME_STATE.BOARD_TILES[i]?.[j]
                    if(!tileObj || tileObj.symbol == 1 || (tileObj.symbol == 2 && !wheelClick)
                        || tileObj.visible || !GAME_STATE.active) 
                        continue;
                    if(tileObj.value == 'mine') return gameLost()
    
                    tileObj.tile.querySelector('.tile-inner').style.display = 'none'
                    tileObj.visible = true;
                    tileObj.symbol = 0;
                    if(tileObj.value){
                        tileObj.tile.innerText = tileObj.value
                        tileObj.tile.style.color = `var(--number-${tileObj.value})`
                        continue;
                    }
                }
                firstRun = false
                for(let iDelta = -1; iDelta <= 1; iDelta++)
                    for(let jDelta = -1; jDelta <= 1; jDelta++)
                        if(i + iDelta >= 0 && (iDelta != 0 || jDelta != 0))
                            tiles.push([i + iDelta, j + jDelta])
            }
        }
        function checkRevaelSurrounding(i, j){
            const tile = GAME_STATE.BOARD_TILES[i][j].tile
            if(!tile.innerText) return;
            let flags = countSurroundingFlags(i,j)
            if(flags != tile.innerText) return;
            revealBoard(i, j, true)
        }


        function changeGameState(e){
            let el = e.target
            const v = el.getAttribute('value')
            GAME_STATE.GRID_SIZE.height = v == 1 ? 9 : v == 2 ? 16 : 16
            GAME_STATE.GRID_SIZE.width = v == 1 ? 9 : v == 2 ? 16 : 30
            GAME_STATE.MINES_AMOUNT = v == 1 ? 10 : v == 2 ? 40 : 99
            el.parentElement.querySelector(".selected").classList.toggle('selected')
            el.classList.toggle('selected')
            startGame()
            el.blur()
        }

        function isFontAwesomeLoaded() {
            let span = generateElement('span', {class:'fa'})
            span.style.display = 'none';
            document.body.appendChild(span);
            let result = (window.getComputedStyle(span, null).getPropertyValue('font-family').indexOf('FontAwesome') !== -1);
            document.body.removeChild(span);
            return result;
        }

        startGame()
        document.querySelectorAll('.optionContainer button').forEach(el => el.addEventListener('click', changeGameState)) 
        elements.board.addEventListener('mouseup', pressTile)
        elements.board.addEventListener('contextmenu', e => e.preventDefault())
    </script>
</body>
</html>
